name: CI Build and Smoke Test (egret repo)

on:
  push:
    branches: [ main, work ]
  pull_request:
    branches: [ main, work ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install build tool
        run: |
          python -m pip install --upgrade pip build

      - name: Install TOML helper
        run: |
          python -m pip install toml

      - name: Read package version
        id: read_version
        run: |
          VERSION=$(python -c "import re,sys;print(re.search(r'__version__\\s*=\\s*[\"\']([^\"\']+)[\"\']', open('egret/version.py').read()).group(1))")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Sync pyproject version (safe)
        run: |
          echo "Syncing pyproject.toml project.version from egret/version.py using scripts/sync_version.py"
          python scripts/sync_version.py --version-file egret/version.py --pyproject pyproject.toml

      - name: Build wheel (PEP 517 / scikit-build-core)
        run: |
          python -m build -w -o dist_wheels

      - name: Create venv and install wheel
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install dist_wheels/*.whl

      - name: Smoke test import
        run: |
          source .venv/bin/activate
          python -c "import importlib; m=importlib.import_module('egret._pyegret_bridge'); print('PYEGRET_AVAILABLE=', getattr(m,'_PYEGRET_AVAILABLE', None))"

  cmake-build-and-test:
    name: CMake + PyBind11 Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            use_openmp: ON
          - os: macos-latest
            use_openmp: OFF

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system packages (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libeigen3-dev libomp-dev python3-dev python3-pip

      - name: Install Homebrew packages (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew update
          brew install eigen

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pybind11 pytest numpy

      - name: Configure CMake
        env:
          PYBIND11_DIR: $(python -m pybind11 --cmakedir)
        run: |
          echo "pybind11 cmake dir: $PYBIND11_DIR"
          cmake -S cpp -B cpp/build -DBUILD_PYEXT=ON -DUSE_OPENMP=${{ matrix.use_openmp }} -Dpybind11_DIR="$PYBIND11_DIR"

      - name: Build
        run: cmake --build cpp/build --config Release -- -j 2

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}: ${{ github.workspace }}/cpp/build
        run: |
          python -m pytest -q cpp/tests
